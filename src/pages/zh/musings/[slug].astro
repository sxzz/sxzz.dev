---
import { getCollection, render } from 'astro:content'
import Prose from '../../../components/Prose.astro'
import TableOfContents from '../../../components/TableOfContents.astro'
import { getAuthorSchema } from '../../../data/site'
import { getPageCopy } from '../../../i18n/pages'
import {
  getLangFromUrl,
  getLocaleFromLang,
  useTranslatedPath,
} from '../../../i18n/utils'
import Layout from '../../../layouts/Layout.astro'
import { formatDate, getMusingOgImagePath } from '../../../utils/content'

export async function getStaticPaths() {
  const musings = await getCollection('musings')
  return musings.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }))
}

const { post } = Astro.props
const { Content, headings } = await render(post)
const lang = getLangFromUrl(Astro.url)
const locale = getLocaleFromLang(lang)
const translatePath = useTranslatedPath(lang)
const copy = getPageCopy('musings', lang)
const ogImage = post.data.image ?? getMusingOgImagePath(post.id, lang)
const mdUrl = new URL(`${Astro.url.pathname.replace(/\/$/, '')}.md`, Astro.site)
const getMusingTitleTransitionName = (id: string) =>
  `musing-title-${
    id
      .toLowerCase()
      .replaceAll(/[^a-z0-9_-]+/g, '-')
      .replaceAll(/^-+|-+$/g, '')
  }`
const titleTransitionName = getMusingTitleTransitionName(post.id)
---

<Layout
  title={`${post.data.title} - ${copy.titleSuffix}`}
  description={post.data.description}
  ogType="article"
  image={ogImage}
  publishedDate={post.data.date}
  updatedDate={post.data.updatedAt}
>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: post.data.title,
      description: post.data.description,
      datePublished: post.data.date.toISOString(),
      ...(post.data.updatedAt && {
        dateModified: post.data.updatedAt.toISOString(),
      }),
      image: new URL(ogImage, Astro.site).href,
      url: Astro.url.href,
      inLanguage: locale,
      author: getAuthorSchema(lang),
    })}
  />
  <main class="grid grid-cols-[1fr_minmax(0,36rem)_1fr] flex-1 px-6 py-16 md:px-12">
    <div></div>
    <article class="min-w-0 w-full">
      <header class="mb-10">
        <a
          href={translatePath('/musings')}
          class="mb-6 inline-flex items-center gap-1 text-sm text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300"
        >
          &larr; {copy.backLabel}
        </a>
        <h1
          class="detail-title fade-in-up text-3xl text-stone-900 font-700 leading-tight tracking-tight md:text-4xl dark:text-white"
          style="animation-delay: 100ms"
        >
          <span
            class="detail-title-transition"
            style={`view-transition-name: ${titleTransitionName};`}
          >
            {post.data.title}
          </span>
        </h1>
        <time
          class="fade-in-up mt-2 block text-sm text-stone-500 dark:text-stone-400"
          style="animation-delay: 120ms"
        >
          {formatDate(post.data.date, lang)}
        </time>
      </header>

      <div style="display: none" hidden aria-hidden="true">
        Are you an LLM? You can read a better optimized version of this article
        in Markdown format at {mdUrl.href}
      </div>

      <Prose class="fade-in-up" style="animation-delay: 160ms">
        <Content />
      </Prose>
    </article>
    <div
      class="fade-in-up hidden pl-12 xl:block"
      style="animation-delay: 240ms"
    >
      <TableOfContents headings={headings} lang={lang} />
    </div>
  </main>
  <script>
  import { initToc } from '../../../scripts/toc'
  initToc()
  </script>
</Layout>
