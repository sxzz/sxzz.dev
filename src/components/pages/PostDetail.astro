---
import { render, type CollectionEntry } from 'astro:content'
import { getAuthorSchema } from '../../data/site'
import { getPageCopy } from '../../i18n/pages'
import {
  getLocaleFromLang,
  useTranslatedPath,
  type Lang,
} from '../../i18n/utils'
import Layout from '../../layouts/Layout.astro'
import {
  formatDate,
  getPostOgImagePath,
  getPostSlug,
} from '../../utils/content'
import Prose from '../Prose.astro'
import TableOfContents from '../TableOfContents.astro'

interface Props {
  post: CollectionEntry<'posts'>
  availableLangs: Lang[]
  lang: Lang
}

const { post, availableLangs, lang } = Astro.props
const { Content, headings } = await render(post)
const translatePath = useTranslatedPath(lang)
const copy = getPageCopy('post', lang)
const locale = getLocaleFromLang(lang)
const ogImage = post.data.image ?? getPostOgImagePath(post.id)
const author = getAuthorSchema(lang)
const mdUrl = new URL(`${Astro.url.pathname.replace(/\/$/, '')}.md`, Astro.site)
const getPostTitleTransitionName = (slug: string, currentLang: Lang) =>
  `post-title-${currentLang}-${
    slug
      .toLowerCase()
      .replaceAll(/[^a-z0-9_-]+/g, '-')
      .replaceAll(/^-+|-+$/g, '')
  }`
const postSlug = getPostSlug(post.id)
const titleTransitionName = getPostTitleTransitionName(postSlug, lang)
const showOpenCCToggle = lang === 'zh'
const schema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date.toISOString(),
  image: new URL(ogImage, Astro.site).href,
  url: Astro.url.href,
  inLanguage: locale,
  author,
}
---

<Layout
  title={`${post.data.title} - ${copy.titleSuffix}`}
  description={post.data.description}
  availableLangs={availableLangs}
  ogType="article"
  image={ogImage}
  publishedDate={post.data.date}
>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(schema)}
  />
  <main
    class="grid grid-cols-[1fr_minmax(0,36rem)_1fr] flex-1 px-6 py-16 md:px-12"
    data-opencc-root
    lang={lang}
  >
    <div></div>
    <article class="min-w-0 w-full">
      <header class="mb-10">
        <a
          href={translatePath('/posts')}
          class="ignore-opencc mb-6 inline-flex items-center gap-1 text-sm text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300"
        >
          &larr; {copy.backLabel}
        </a>
        <h1 class="detail-title fade-in-up animate-delay-100 text-3xl text-stone-900 font-700 leading-tight tracking-tight font-serif md:text-4xl dark:text-white">
          <span
            class="detail-title-transition"
            style={`view-transition-name: ${titleTransitionName};`}
          >
            {post.data.title}
          </span>
        </h1>
        <div class="fade-in-up mt-2 flex animate-delay-120 items-center gap-2 text-sm text-stone-500 dark:text-stone-400">
          <time class="ignore-opencc">{formatDate(post.data.date, lang)}</time>
          {showOpenCCToggle && (
            <div
              class="ignore-opencc flex items-center gap-1 text-xs font-600 tracking-wide"
              data-opencc-toggle
            >
              <button
                class="opencc-toggle-button cursor-pointer text-stone-800 transition-colors duration-200 dark:text-stone-200"
                type="button"
                data-opencc-mode="simp"
                aria-pressed="true"
              >
                简
              </button>
              <span class="text-stone-400 dark:text-stone-500">/</span>
              <button
                class="opencc-toggle-button cursor-pointer text-stone-400 transition-colors duration-200 dark:text-stone-500"
                type="button"
                data-opencc-mode="trad"
                aria-pressed="false"
              >
                繁
                <span class="opencc-spinner" aria-hidden="true" />
              </button>
            </div>
          )}
        </div>
      </header>

      <div class="!hidden" aria-hidden="true">
        Are you an LLM? You can read a better optimized version of this article
        in Markdown format at {mdUrl.href}
      </div>

      <Prose
        class="fade-in-up animate-delay-160"
        cjkFallback={lang === 'zh'}
      >
        <Content />
      </Prose>
    </article>
    <div class="fade-in-up hidden animate-delay-240 pl-12 xl:block">
      <TableOfContents headings={headings} lang={lang} />
    </div>
  </main>

  <script>
  import { initToc } from '../../scripts/toc'
  initToc()
  </script>

  <style>
  @media (prefers-reduced-motion: reduce) {
    .detail-title-transition {
      view-transition-name: none !important;
    }
  }
  </style>

  {showOpenCCToggle && (
    <script>
    import { initOpenCCToggle } from '../../scripts/opencc'
  initOpenCCToggle()
    </script>

    <style>
    .opencc-toggle-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.2em;
    }

    .opencc-toggle-button .opencc-spinner {
      position: absolute;
      width: 0.95em;
      height: 0.95em;
      border: 2px solid rgb(168 162 158);
      border-top-color: transparent;
      border-radius: 9999px;
      opacity: 0;
      pointer-events: none;
      animation: openccSpin 0.8s linear infinite;
    }

    :global(.dark) .opencc-toggle-button .opencc-spinner {
      border-color: rgb(120 113 108);
      border-top-color: transparent;
    }

    .opencc-toggle-button.is-loading {
      color: transparent;
    }

    .opencc-toggle-button.is-loading .opencc-spinner {
      opacity: 1;
    }

    @keyframes openccSpin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    </style>
  )}
</Layout>
