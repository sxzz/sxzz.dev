---
import { getLangFromUrl, useTranslations } from '../i18n/utils'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
---

<button
  id="theme-toggle"
  aria-label={t('toggle.theme')}
  class="cursor-pointer p-1 text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200"
>
  <svg
    class="h-4 w-4 dark:hidden"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
  <svg
    class="hidden h-4 w-4 dark:block"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
</button>

<script>
  const prefersDarkQuery = globalThis.matchMedia('(prefers-color-scheme: dark)')
  const prefersReducedMotionQuery = globalThis.matchMedia(
    '(prefers-reduced-motion: reduce)',
  )

  function applyTheme(doc = document) {
    const stored = localStorage.getItem('theme')
    const shouldDark = stored ? stored === 'dark' : prefersDarkQuery.matches
    doc.documentElement.classList.toggle('dark', shouldDark)
  }

  function toggleTheme() {
    const shouldDark = !document.documentElement.classList.contains('dark')
    const apply = () => {
      if (shouldDark === prefersDarkQuery.matches) {
        localStorage.removeItem('theme')
      } else {
        localStorage.setItem('theme', shouldDark ? 'dark' : 'light')
      }
      document.documentElement.classList.toggle('dark', shouldDark)
    }

    if (!document.startViewTransition || prefersReducedMotionQuery.matches) {
      apply()
      return
    }
    document.startViewTransition(() => {
      apply()
    })
  }

  document.addEventListener('click', (e) => {
    const target = e.target
    const targetEl = target instanceof Element ? target : null
    if (targetEl?.closest('#theme-toggle')) {
      toggleTheme()
    }
  })

  prefersDarkQuery.addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      document.documentElement.classList.toggle('dark', e.matches)
    }
  })

  document.addEventListener('astro:before-swap', (event) => {
    applyTheme(event.newDocument)
  })

  document.addEventListener('astro:page-load', () => {
    applyTheme()
  })
</script>
