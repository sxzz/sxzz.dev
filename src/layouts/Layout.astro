---
import '@unocss/reset/tailwind.css'
import { nav, social } from '../consts'
import { defaultLang, languages, localeByLang } from '../i18n/ui'
import { getLangFromUrl, getPathWithoutLang, useTranslations, useTranslatedPath } from '../i18n/utils'

interface Props {
  title: string
  description?: string
  availableLangs?: (keyof typeof languages)[]
  image?: string
  ogType?: 'website' | 'article'
  publishedDate?: Date
  updatedDate?: Date
}

const { title, description, availableLangs, image, ogType = 'website', publishedDate, updatedDate } = Astro.props
const pathname = Astro.url.pathname
const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const translatePath = useTranslatedPath(lang)
const basePath = getPathWithoutLang(pathname)
const languageKeys = Object.keys(languages) as (keyof typeof languages)[]
const showLangSwitcher = !basePath.startsWith('/musings')

const site = Astro.site!
const canonicalURL = new URL(pathname, site)
const ogImage = image ? new URL(image, site).href : new URL('/og-default.png', site).href
const locale = localeByLang[lang]

const isMusingsPage = basePath.startsWith('/musings')
const hreflangLangs = isMusingsPage
  ? []
  : languageKeys.filter((l) => !availableLangs || availableLangs.includes(l))
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <link rel="canonical" href={canonicalURL.href} />

    {hreflangLangs.map((l) => {
      const href = new URL(l === defaultLang ? basePath || '/' : `/${l}${basePath || '/'}`, site).href
      return <link rel="alternate" hreflang={localeByLang[l]} href={href} />
    })}
    {hreflangLangs.length > 1 && (
      <link rel="alternate" hreflang="x-default" href={new URL(basePath || '/', site).href} />
    )}

    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:site_name" content="Kevin Deng" />
    <meta property="og:type" content={ogType} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={locale} />
    {hreflangLangs.filter((l) => l !== lang).map((l) => (
      <meta property="og:locale:alternate" content={localeByLang[l]} />
    ))}
    {ogType === 'article' && publishedDate && (
      <meta property="article:published_time" content={publishedDate.toISOString()} />
    )}
    {ogType === 'article' && updatedDate && (
      <meta property="article:modified_time" content={updatedDate.toISOString()} />
    )}

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={ogImage} />

    <link rel="alternate" type="application/rss+xml" title={lang === 'zh' ? '智子' : 'Kevin Deng'} href={new URL(lang === 'zh' ? '/zh/rss.xml' : '/rss.xml', site).href} />

    <slot name="head" />
    <script defer data-domain="sxzz.dev" src="https://analytics.sxzz.dev/js/script.js"></script>
    <script is:inline>
      ;(function () {
        const stored = localStorage.getItem('theme')
        const prefersDark = window.matchMedia(
          '(prefers-color-scheme: dark)',
        ).matches
        if (stored === 'dark' || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark')
        }
      })()
    </script>
  </head>
  <body
    class="min-h-dvh flex flex-col bg-stone-50 dark:bg-stone-950 text-stone-800 dark:text-stone-200 antialiased selection:bg-stone-900/10 dark:selection:bg-stone-100/10"
  >
    <nav
      class="w-full px-6 md:px-12 py-5 flex items-center justify-between fade-in"
    >
      <a
        href={translatePath('/')}
        class:list={[
          'text-xl font-600 text-stone-800 dark:text-stone-200 tracking-tight hover:text-stone-500 dark:hover:text-stone-400 transition-colors duration-200',
          lang !== 'zh' && 'font-serif',
        ]}
      >
        {lang === 'zh' ? '智子' : 'Kevin Deng'}{(pathname === '/' || pathname === '/zh/' || pathname === '/zh') &&
          <span class="terminal-cursor font-mono text-base ml-0.5" aria-hidden="true">_</span>
        }
      </a>
      <div
        class="flex items-center gap-6 text-sm font-500 text-stone-400 dark:text-stone-500"
      >
        {
          nav
            .filter((item) => !item.langs || item.langs.includes(lang))
            .map((item) => (
              <a
                href={translatePath(item.href)}
                class:list={[
                  'transition-colors duration-200',
                  pathname.startsWith(translatePath(item.href))
                    ? 'text-stone-800 dark:text-stone-200'
                    : 'hover:text-stone-800 dark:hover:text-stone-200',
                ]}
              >
                {t(item.key as any)}
              </a>
            ))
        }
        {showLangSwitcher && <details class="lang-switcher relative text-xs font-600 uppercase tracking-wide">
          <summary class="list-none cursor-pointer text-stone-400 dark:text-stone-500 hover:text-stone-800 dark:hover:text-stone-200 transition-colors duration-200 select-none">
            {t(`lang.${lang}` as any) ?? languages[lang]}
          </summary>
          <div class="lang-switcher-menu absolute right-1/2 translate-x-1/2 mt-2 py-1.5 min-w-22 bg-white/80 dark:bg-stone-900/80 backdrop-blur-sm border border-stone-200/50 dark:border-stone-800/50 rounded-lg shadow-lg z-10">
            {languageKeys.filter((key) => key !== lang).map((key) => {
              const label = t(`lang.${key}` as any) ?? languages[key]
              const isAvailable = !availableLangs || availableLangs.includes(key)
              const href = isAvailable ? translatePath(basePath, key) : translatePath('/', key)
              return (
                <a
                  href={href}
                  class:list={[
                    'block px-3 py-1 text-center transition-colors duration-200',
                    isAvailable
                      ? 'text-stone-500 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200'
                      : 'text-stone-300 dark:text-stone-700 line-through',
                  ]}
                >
                  {label}
                </a>
              )
            })}
          </div>
        </details>}
        <button
          id="theme-toggle"
          aria-label={t('toggle.theme')}
          class="p-1 text-stone-400 dark:text-stone-500 hover:text-stone-800 dark:hover:text-stone-200 transition-colors duration-200 cursor-pointer"
        >
          <svg
            class="w-4 h-4 dark:hidden"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg
            class="w-4 h-4 hidden dark:block"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
      </div>
    </nav>

    <slot />

    <footer
      class="w-full px-6 md:px-12 py-6 flex items-center justify-center gap-5 border-t border-stone-200/60 dark:border-stone-800/60 fade-in-up"
    >
      {
        social.map((link) => (
          <a
            href={link.localeHref?.[lang] ?? link.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-stone-400 dark:text-stone-600 hover:text-stone-700 dark:hover:text-stone-300 transition-colors duration-200"
            aria-label={link.label}
          >
            <div class:list={[link.icon, 'w-5 h-5']} />
          </a>
        ))
      }
    </footer>
  </body>
</html>

<script>
  const toggle = document.getElementById('theme-toggle')
  toggle?.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark')
    localStorage.setItem('theme', isDark ? 'dark' : 'light')
  })

  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        document.documentElement.classList.toggle('dark', e.matches)
      }
    })

  document.addEventListener('click', (e) => {
    document.querySelectorAll('.lang-switcher[open]').forEach((el) => {
      if (!el.contains(e.target as Node)) el.removeAttribute('open')
    })
  })

  document.querySelectorAll('.lang-switcher').forEach((el) => {
    el.addEventListener('toggle', () => {
      if ((el as HTMLDetailsElement).open) {
        const menu = el.querySelector('.lang-switcher-menu') as HTMLElement
        if (menu) {
          menu.style.animation = 'none'
          menu.offsetHeight
          menu.style.animation = ''
        }
      }
    })
  })
</script>

<style is:global>
  .lang-switcher summary::-webkit-details-marker {
    display: none;
  }

  @keyframes langMenuIn {
    from {
      opacity: 0;
      transform: translateX(50%) translateY(-4px) scale(0.96);
    }
    to {
      opacity: 1;
      transform: translateX(50%) translateY(0) scale(1);
    }
  }

  .lang-switcher[open] .lang-switcher-menu {
    animation: langMenuIn 0.15s ease both;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(14px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out both;
  }

  .fade-in-up {
    animation: fadeInUp 0.5s ease-out both;
  }

  @keyframes cursorBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .terminal-cursor {
    animation: cursorBlink 1s step-end infinite;
    color: inherit;
  }

  @media (prefers-reduced-motion: reduce) {
    .terminal-cursor {
      animation: none;
      display: none;
    }
  }
</style>
