---
import '@unocss/reset/tailwind.css'
import { nav, social } from '../consts'
import { languages } from '../i18n/ui'
import { getLangFromUrl, getPathWithoutLang, useTranslations, useTranslatedPath } from '../i18n/utils'

interface Props {
  title: string
  description?: string
}

const { title, description } = Astro.props
const pathname = Astro.url.pathname
const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const translatePath = useTranslatedPath(lang)
const basePath = getPathWithoutLang(pathname)
const languageKeys = Object.keys(languages) as (keyof typeof languages)[]
const showLangSwitcher = !basePath.startsWith('/musings')
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <script is:inline>
      ;(function () {
        const stored = localStorage.getItem('theme')
        const prefersDark = window.matchMedia(
          '(prefers-color-scheme: dark)',
        ).matches
        if (stored === 'dark' || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark')
        }
      })()
    </script>
  </head>
  <body
    class="min-h-dvh flex flex-col bg-stone-50 dark:bg-stone-950 text-stone-800 dark:text-stone-200 antialiased selection:bg-stone-900/10 dark:selection:bg-stone-100/10"
  >
    <nav
      class="w-full px-6 md:px-12 py-5 flex items-center justify-between fade-in"
    >
      <a
        href={translatePath('/')}
        class:list={[
          'text-xl font-600 text-stone-800 dark:text-stone-200 tracking-tight hover:text-stone-500 dark:hover:text-stone-400 transition-colors duration-200',
          lang !== 'zh' && 'font-serif',
        ]}
      >
        {lang === 'zh' ? '智子' : 'Kevin Deng'}{(pathname === '/' || pathname === '/zh/' || pathname === '/zh') &&
          <span class="terminal-cursor font-mono text-base ml-0.5" aria-hidden="true">_</span>
        }
      </a>
      <div
        class="flex items-center gap-6 text-sm font-500 text-stone-400 dark:text-stone-500"
      >
        {
          nav
            .filter((item) => !item.langs || item.langs.includes(lang))
            .map((item) => (
              <a
                href={translatePath(item.href)}
                class:list={[
                  'transition-colors duration-200',
                  pathname.startsWith(translatePath(item.href))
                    ? 'text-stone-800 dark:text-stone-200'
                    : 'hover:text-stone-800 dark:hover:text-stone-200',
                ]}
              >
                {t(item.key as any)}
              </a>
            ))
        }
        {showLangSwitcher && <div class="flex items-center">
          <select
            aria-label={t('lang.switch')}
            class="bg-transparent text-xs font-600 uppercase tracking-wide text-stone-500 dark:text-stone-400 border border-stone-200/70 dark:border-stone-800/80 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-stone-300/50 dark:focus:ring-stone-700/50"
            onchange="window.location.href = this.value"
          >
            {languageKeys.map((key) => {
              const label = t(`lang.${key}` as any) ?? languages[key]
              return (
                <option value={translatePath(basePath, key)} selected={lang === key}>
                  {label}
                </option>
              )
            })}
          </select>
        </div>}
        <button
          id="theme-toggle"
          aria-label={t('toggle.theme')}
          class="p-1 text-stone-400 dark:text-stone-500 hover:text-stone-800 dark:hover:text-stone-200 transition-colors duration-200 cursor-pointer"
        >
          <svg
            class="w-4 h-4 dark:hidden"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg
            class="w-4 h-4 hidden dark:block"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
      </div>
    </nav>

    <slot />

    <footer
      class="w-full px-6 md:px-12 py-6 flex items-center justify-center gap-5 border-t border-stone-200/60 dark:border-stone-800/60 fade-in-up"
    >
      {
        social.map((link) => (
          <a
            href={link.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-stone-400 dark:text-stone-600 hover:text-stone-700 dark:hover:text-stone-300 transition-colors duration-200"
            aria-label={link.label}
          >
            <div class:list={[link.icon, 'w-5 h-5']} />
          </a>
        ))
      }
    </footer>
  </body>
</html>

<script>
  const toggle = document.getElementById('theme-toggle')
  toggle?.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark')
    localStorage.setItem('theme', isDark ? 'dark' : 'light')
  })

  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        document.documentElement.classList.toggle('dark', e.matches)
      }
    })
</script>

<style is:global>
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(14px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out both;
  }

  .fade-in-up {
    animation: fadeInUp 0.5s ease-out both;
  }

  @keyframes cursorBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .terminal-cursor {
    animation: cursorBlink 1s step-end infinite;
    color: inherit;
  }

  @media (prefers-reduced-motion: reduce) {
    .terminal-cursor {
      animation: none;
      display: none;
    }
  }
</style>
