---
import { ClientRouter } from 'astro:transitions'
import { nav, social } from '../consts'
import { defaultLang, languages, localeByLang } from '../i18n/ui'
import {
  getLangFromUrl,
  getPathWithoutLang,
  useTranslatedPath,
  useTranslations,
} from '../i18n/utils'
import '@unocss/reset/tailwind.css'
import { pageCopy } from '../i18n/pages'

interface Props {
  title: string
  description?: string
  availableLangs?: (keyof typeof languages)[]
  image?: string
  ogType?: 'website' | 'article'
  publishedDate?: Date
  updatedDate?: Date
}

const {
  title,
  description,
  availableLangs,
  image,
  ogType = 'website',
  publishedDate,
  updatedDate,
} = Astro.props
const pathname = Astro.url.pathname
const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const translatePath = useTranslatedPath(lang)
const basePath = getPathWithoutLang(pathname)
const languageKeys = Object.keys(languages) as (keyof typeof languages)[]
const showLangSwitcher = !basePath.startsWith('/musings')

const site = Astro.site!
const canonicalURL = new URL(pathname, site)
const ogImage = image
  ? new URL(image, site).href
  : new URL('/og-default.png', site).href
const locale = localeByLang[lang]

const isMusingsPage = basePath.startsWith('/musings')
const hreflangLangs = isMusingsPage
  ? []
  : languageKeys.filter((l) => !availableLangs || availableLangs.includes(l))
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <link rel="canonical" href={canonicalURL.href} />

    {
      hreflangLangs.map((l) => {
        const href = new URL(
          l === defaultLang ? basePath || '/' : `/${l}${basePath || '/'}`,
          site,
        ).href
        return <link rel="alternate" hreflang={localeByLang[l]} href={href} />
      })
    }
    {
      hreflangLangs.length > 1 && (
        <link
          rel="alternate"
          hreflang="x-default"
          href={new URL(basePath || '/', site).href}
        />
      )
    }

    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:site_name" content={pageCopy.home[lang].name} />
    <meta property="og:type" content={ogType} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={locale} />
    {
      hreflangLangs
        .filter((l) => l !== lang)
        .map((l) => (
          <meta property="og:locale:alternate" content={localeByLang[l]} />
        ))
    }
    {
      ogType === 'article' && publishedDate && (
        <meta
          property="article:published_time"
          content={publishedDate.toISOString()}
        />
      )
    }
    {
      ogType === 'article' && updatedDate && (
        <meta
          property="article:modified_time"
          content={updatedDate.toISOString()}
        />
      )
    }

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={title} />

    <link
      rel="alternate"
      type="application/rss+xml"
      title={pageCopy.home[lang].name}
      href={new URL(lang !== 'en' ? `/${lang}/rss.xml` : '/rss.xml', site).href}
    />

    <ClientRouter />
    <slot name="head" />
    <script
      defer
      data-domain="sxzz.dev"
      src="https://analytics.sxzz.dev/js/script.js"></script>
    <script is:inline>
      ;(function () {
        const stored = localStorage.getItem('theme')
        const prefersDark = globalThis.matchMedia(
          '(prefers-color-scheme: dark)',
        ).matches
        if (stored === 'dark' || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark')
        }
      })()
    </script>
  </head>
  <body
    class="flex flex-col bg-stone-50 text-stone-800 antialiased min-h-dvh dark:bg-stone-950 selection:bg-stone-900/10 dark:text-stone-200 dark:selection:bg-stone-100/10"
    style="text-autospace:normal"
  >
    <nav
      class="fade-in w-full flex items-center justify-between gap-4 px-4 py-5 md:px-12 sm:px-6"
    >
      <a
        href={translatePath('/')}
        class:list={[
          'flex-shrink-0 text-xl font-600 text-stone-800 dark:text-stone-200 tracking-tight hover:text-stone-500 dark:hover:text-stone-400 transition-colors duration-200',
          pageCopy.home[lang].nameSerif && 'font-serif',
        ]}
      >
        {pageCopy.home[lang].name}{
          (pathname === '/' || pathname === '/zh/' || pathname === '/zh') && (
            <span
              class="terminal-cursor ml-0.5 text-base font-mono"
              aria-hidden="true"
            >
              _
            </span>
          )
        }
      </a>
      <div
        class="flex items-center gap-3 text-sm text-stone-500 font-500 md:gap-6 sm:gap-4 dark:text-stone-400"
      >
        {
          nav
            .filter((item) => !item.langs || item.langs.includes(lang))
            .map((item) => (
              <a
                href={translatePath(item.href)}
                class:list={[
                  'transition-colors duration-200',
                  pathname.startsWith(translatePath(item.href))
                    ? 'text-stone-800 dark:text-stone-200'
                    : 'hover:text-stone-800 dark:hover:text-stone-200',
                ]}
              >
                {t(item.key as any)}
              </a>
            ))
        }
        {
          showLangSwitcher && (
            <details class="lang-switcher relative text-xs font-600 tracking-wide uppercase">
              <summary class="cursor-pointer select-none list-none text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200">
                {t(`lang.${lang}` as any) ?? languages[lang]}
              </summary>
              <div class="lang-switcher-menu absolute right-1/2 z-10 mt-2 min-w-22 translate-x-1/2 border border-stone-200/50 rounded-lg bg-white/80 py-1.5 shadow-lg backdrop-blur-sm dark:border-stone-800/50 dark:bg-stone-900/80">
                {languageKeys
                  .filter((key) => key !== lang)
                  .map((key) => {
                    const label = t(`lang.${key}` as any) ?? languages[key]
                    const isAvailable =
                      !availableLangs || availableLangs.includes(key)
                    const href = isAvailable
                      ? translatePath(basePath, key)
                      : translatePath('/', key)
                    return (
                      <a
                        href={href}
                        class:list={[
                          'block px-3 py-1 text-center transition-colors duration-200',
                          isAvailable
                            ? 'text-stone-500 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200'
                            : 'text-stone-300 dark:text-stone-700 line-through',
                        ]}
                      >
                        {label}
                      </a>
                    )
                  })}
              </div>
            </details>
          )
        }
        <a
          href={new URL(lang === 'zh' ? '/zh/rss.xml' : '/rss.xml', site).href}
          target="_blank"
          rel="noopener noreferrer"
          aria-label="RSS"
          class="p-1 text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200"
        >
          <div class="i-simple-icons-rss h-3.5 w-3.5"></div>
        </a>
        <button
          id="theme-toggle"
          aria-label={t('toggle.theme')}
          class="cursor-pointer p-1 text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200"
        >
          <svg
            class="h-4 w-4 dark:hidden"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg
            class="hidden h-4 w-4 dark:block"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
      </div>
    </nav>

    <slot />

    <footer
      class="fade-in w-full flex items-center justify-center gap-5 border-t border-stone-200/60 px-6 py-6 dark:border-stone-800/60 md:px-12"
    >
      {
        social.map((link) => (
          <a
            href={link.localeHref?.[lang] ?? link.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-stone-500 transition-colors duration-200 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300"
            aria-label={link.label}
          >
            <div class:list={[link.icon, 'w-5 h-5']} />
          </a>
        ))
      }
    </footer>
  </body>
</html>

<script>
  import NProgress from 'nprogress'

  const prefersDarkQuery = globalThis.matchMedia('(prefers-color-scheme: dark)')

  const applyTheme = (doc = document) => {
    const stored = localStorage.getItem('theme')
    const shouldDark = stored ? stored === 'dark' : prefersDarkQuery.matches
    doc.documentElement.classList.toggle('dark', shouldDark)
  }

  const toggleTheme = () => {
    const isDark = !document.documentElement.classList.contains('dark')
    if (isDark === prefersDarkQuery.matches) {
      localStorage.removeItem('theme')
    } else {
      localStorage.setItem('theme', isDark ? 'dark' : 'light')
    }
    document.documentElement.classList.toggle('dark', isDark)
  }

  NProgress.configure({
    showSpinner: false,
    trickleSpeed: 120,
    minimum: 0.08,
  })

  let nprogressTimer = 0

  const startProgress = () => {
    if (nprogressTimer) return
    nprogressTimer = window.setTimeout(() => {
      NProgress.start()
    }, 120)
  }

  const stopProgress = () => {
    if (nprogressTimer) {
      clearTimeout(nprogressTimer)
      nprogressTimer = 0
    }
    NProgress.done(true)
  }

  document.addEventListener('click', (e) => {
    const target = e.target
    const targetEl = target instanceof Element ? target : null
    if (targetEl?.closest('#theme-toggle')) {
      toggleTheme()
    }

    document.querySelectorAll('.lang-switcher[open]').forEach((el) => {
      if (targetEl && el.contains(targetEl)) return
      el.removeAttribute('open')
    })
  })

  document.addEventListener('astro:before-preparation', startProgress)
  document.addEventListener('astro:after-swap', stopProgress)
  document.addEventListener('astro:page-load', stopProgress)

  prefersDarkQuery.addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      document.documentElement.classList.toggle('dark', e.matches)
    }
  })

  document.addEventListener('astro:before-swap', (e) => {
    const event = e as { newDocument?: Document }
    if (event?.newDocument) {
      applyTheme(event.newDocument)
    }
  })

  document.addEventListener('astro:page-load', () => {
    applyTheme()
  })

  document.addEventListener(
    'toggle',
    (e) => {
      const details = e.target
      if (!(details instanceof HTMLDetailsElement)) return
      if (!details.classList.contains('lang-switcher') || !details.open) return
      const menu = details.querySelector(
        '.lang-switcher-menu',
      ) as HTMLElement | null
      if (menu) {
        menu.style.animation = 'none'
        // eslint-disable-next-line no-void -- trigger reflow
        void menu.offsetHeight
        menu.style.animation = ''
      }
    },
    true,
  )
</script>

<style is:global>
  .lang-switcher summary::-webkit-details-marker {
    display: none;
  }

  @keyframes langMenuIn {
    from {
      opacity: 0;
      transform: translateX(50%) translateY(-4px) scale(0.96);
    }
    to {
      opacity: 1;
      transform: translateX(50%) translateY(0) scale(1);
    }
  }

  .lang-switcher[open] .lang-switcher-menu {
    animation: langMenuIn 0.15s ease both;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(14px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out both;
  }

  .fade-in-up {
    animation: fadeInUp 0.5s ease-out both;
  }

  @keyframes cursorBlink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }

  .terminal-cursor {
    animation: cursorBlink 1s step-end infinite;
    color: inherit;
  }

  :root {
    --nprogress-color: rgba(28, 25, 23, 0.45);
  }

  .dark {
    --nprogress-color: rgba(231, 229, 228, 0.5);
  }

  #nprogress {
    pointer-events: none;
  }

  #nprogress .bar {
    background: var(--nprogress-color);
    position: fixed;
    z-index: 1031;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
  }

  #nprogress .peg {
    display: block;
    position: absolute;
    right: 0;
    width: 100px;
    height: 100%;
    box-shadow: 0 0 6px var(--nprogress-color),
      0 0 3px var(--nprogress-color);
    opacity: 1;
    transform: rotate(3deg) translate(0, -4px);
  }

  #nprogress .spinner {
    display: block;
    position: fixed;
    z-index: 1031;
    top: 15px;
    right: 15px;
  }

  #nprogress .spinner-icon {
    width: 18px;
    height: 18px;
    box-sizing: border-box;
    border: solid 2px transparent;
    border-top-color: var(--nprogress-color);
    border-left-color: var(--nprogress-color);
    border-radius: 50%;
    animation: nprogress-spinner 400ms linear infinite;
  }

  .nprogress-custom-parent {
    overflow: hidden;
    position: relative;
  }

  .nprogress-custom-parent #nprogress .spinner,
  .nprogress-custom-parent #nprogress .bar {
    position: absolute;
  }

  @keyframes nprogress-spinner {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  html {
    scroll-padding-top: 5rem;
  }

  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .terminal-cursor {
      animation: none;
      display: none;
    }
  }
</style>
